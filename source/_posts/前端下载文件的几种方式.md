---
title: 前端下载文件的几种方式
date: 2018-03-19 10:08:51
tags: javascript
---

### 前言
最近开发中，因为主要负责了几个后台管理系统，经常遇到导出excel的需求。一番实验，整理几个方法，分享给大家。

## 创建a标签,模拟点击
```javascript
function download(url, ids) {
    // 创建a标签
    let a = document.createElement("a")
    // 设置url
    a.href = url + '?ids=' + encodeURI(ids)
    // 添加到dom中模拟点击,IE浏览器不添加会失败
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}
```
这种方式最为常见，也比较简单，但是他的缺点也非常明显——***只能`GET`请求下载***
之前,就因为他只能get请求，参数全部挂在url上,导致我们在导出大量数据时,url过长，浏览器直接崩溃.这时,我们就必须使用`POST`请求了

## 创建form表单，模拟提交
```javascript
function download(method, url, ids) {
    // 创建input，设置键值
    let input = document.createElement('input');
    input.hidden = "hidden"
    input.name = "ids"
    input.value = encodeURI(ids)
    // 创建form表单，设置url，method，把input插入form
    let form = document.createElement('form');
    form.action = url
    form.method = method
    form.appendChild(input)
    // 插入dom中，模拟提交
    document.body.appendChild(form);
    form.submit();
    document.body.removeChild(form);
}
```
通过form的提交，就可以适应get、post的各种请求。但是对于ajax使用习惯的我们来说，如果能通过ajax直接处理的话,就更好了。

## 利用ajax获取文件流
```javascript
function download(name, url, params, method = 'GET') {
    let xhr = new XMLHttpRequest()
    // 设置XMLHttpRequest返回类型为Blob
    xhr.responseType = "blob"
    xhr.onreadystatechange = function () {
        if (xhr.readyState == 4) {
            if (xhr.status == 200) {
                // 根据Blob数据创建一个它的url
                let dataUrl = URL.createObjectURL(xhr.response)
                let a = document.createElement("a")
                a.href = dataUrl
                a.download = name
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            }
        }
    }
    if((method == "GET" || method == "get") && params) {
        // 处理get请求的参数
        url = url + '?' + encodeURI(Object.keys(params).map(key => `${key}=${params[key]}`).join('&'))
    }
    xhr.open(method, url)
    let data = null
    if((method == "POST" ||  method == "post") && params) {
        // xhr.setRequestHeader("content-type", "application/x-www-form-urlencoded")
        data = params
    }
    xhr.send(data)
}
```
大致的思路是设置ajax返回数据的类型为`Blob`，然后利用`URL.createObjectURL()`方法根据Blob数据创建一个它的url，最后利用a标签下载。但是它只支持IE10以上